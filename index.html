<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MoodSpace ğŸŒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f172a"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    #map { height: 450px; }
  </style>
</head>

<body class="bg-slate-100 text-slate-900">

<div class="max-w-5xl mx-auto p-4 space-y-6">

  <!-- Header -->
  <header class="text-center space-y-2">
    <h1 class="text-3xl font-bold">MoodSpace ğŸŒ</h1>
    <p class="text-slate-600">
      A real-time map of how the world feels
    </p>
    <p id="worldMood" class="font-semibold text-lg"></p>
  </header>

  <!-- Mood Picker -->
  <section class="bg-white rounded-xl shadow p-6 text-center">
    <h2 class="text-xl font-semibold mb-4">
      How are you feeling right now?
    </h2>

    <div class="flex flex-wrap justify-center gap-4">
      <button onclick="logMood('calm')" class="text-3xl">ğŸ˜Œ</button>
      <button onclick="logMood('happy')" class="text-3xl">ğŸ˜Š</button>
      <button onclick="logMood('focused')" class="text-3xl">ğŸ¯</button>
      <button onclick="logMood('tired')" class="text-3xl">ğŸ˜´</button>
      <button onclick="logMood('sad')" class="text-3xl">ğŸ˜”</button>
      <button onclick="logMood('angry')" class="text-3xl">ğŸ˜¡</button>
    </div>
  </section>

  <!-- Map -->
  <div id="map" class="rounded-xl shadow"></div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================
   MOOD DEFINITIONS
========================= */
const MOODS = {
  calm:   { emoji: "ğŸ˜Œ", color: "#38bdf8" },
  happy:  { emoji: "ğŸ˜Š", color: "#facc15" },
  focused:{ emoji: "ğŸ¯", color: "#2dd4bf" },
  tired:  { emoji: "ğŸ˜´", color: "#a855f7" },
  sad:    { emoji: "ğŸ˜”", color: "#64748b" },
  angry:  { emoji: "ğŸ˜¡", color: "#ef4444" }
};

/* =========================
   MAP INIT
========================= */
const map = L.map('map').setView([0, 0], 2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

/* =========================
   LOAD MOODS (LAST 24H)
========================= */
function loadMoods() {
  map.eachLayer(layer => {
    if (layer instanceof L.CircleMarker) map.removeLayer(layer);
  });

  const moods = JSON.parse(localStorage.getItem('moodLog') || '[]');
  const now = Date.now();
  const last24h = moods.filter(m => now - new Date(m.timestamp) < 86400000);

  const moodCounts = {};

  last24h.forEach(entry => {
    const mood = MOODS[entry.mood];
    moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;

    L.circleMarker([entry.lat, entry.lng], {
      radius: 10,
      color: mood.color,
      fillColor: mood.color,
      fillOpacity: 0.6
    })
    .addTo(map)
    .bindPopup(`
      <div class="text-center">
        <div style="font-size:24px">${mood.emoji}</div>
        <small>${new Date(entry.timestamp).toLocaleString()}</small>
      </div>
    `);
  });

  updateWorldMood(moodCounts);
}

/* =========================
   WORLD MOOD SUMMARY
========================= */
function updateWorldMood(counts) {
  const entries = Object.entries(counts);
  if (!entries.length) {
    document.getElementById("worldMood").innerText = "No moods yet ğŸŒ±";
    return;
  }
  entries.sort((a, b) => b[1] - a[1]);
  const top = entries[0][0];
  document.getElementById("worldMood").innerText =
    `World Mood (24h): Mostly ${top} ${MOODS[top].emoji}`;
}

/* =========================
   LOG MOOD
========================= */
function logMood(moodKey) {
  navigator.geolocation.getCurrentPosition(pos => {
    const entry = {
      mood: moodKey,
      lat: pos.coords.latitude,
      lng: pos.coords.longitude,
      timestamp: new Date().toISOString()
    };

    const moods = JSON.parse(localStorage.getItem('moodLog') || '[]');
    moods.push(entry);
    localStorage.setItem('moodLog', JSON.stringify(moods));

    loadMoods();
    map.setView([entry.lat, entry.lng], 6);
  });
}

/* =========================
   INIT
========================= */
loadMoods();

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>